model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params)
# Compute Stage 1
narrow_dt %>% mutate(lambda_makeham = 0, `Country Name` = Country) %>%
filter(between(Age, 35, 95)) %>%
mutate(
l = log(1/(1-qx+1E-15)),
y = log(l)
) %>%
# Segment the dataset by country and gender
group_by(`Country Name`, Gender) %>% nest %>%
mutate(
# Fit model
model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params) %>% compute_stage2
# Compute Stage 1
narrow_dt %>% mutate(lambda_makeham = 0, `Country Name` = Country) %>%
filter(between(Age, 35, 95)) %>%
mutate(
l = log(1/(1-qx+1E-15)),
y = log(l)
) %>%
# Segment the dataset by country and gender
group_by(`Country Name`, Gender) %>% nest %>%
mutate(
# Fit model
model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params) %>% compute_stage2 %>% compute_table2()
# Compute Stage 1
narrow_dt %>% mutate(lambda_makeham = 0, `Country Name` = Country) %>%
filter(between(Age, 35, 95)) %>%
mutate(
l = log(1/(1-qx+1E-15)),
y = log(l)
) %>%
# Segment the dataset by country and gender
group_by(`Country Name`, Gender) %>% nest %>%
mutate(
# Fit model
model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params) %>% compute_stage2 %>% compute_table2
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
#mutate(lambda_makeham = 0, `Country Name` = Country) %>%
filter(between(Age, 35, 95)) %>%
mutate(
l = log(1/(1-qx+1E-15)),
y = log(l)
) %>%
# Segment the dataset by country and gender
group_by(`Country Name`, Gender) %>% nest %>%
mutate(
# Fit model
model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params) %>% compute_stage2 %>% compute_table2
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
#mutate(lambda_makeham = 0, `Country Name` = Country) %>%
filter(between(Age, 35, 95)) %>%
mutate(
l = log(1/(1-(qx+1E-15) )),
y = log(l-(lambda_makeham)*10^-5)
) %>%
# Segment the dataset by country and gender
group_by(`Country Name`, Gender) %>% nest %>%
mutate(
# Fit model
model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params) %>% compute_stage2 %>% compute_table2
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
mutate(lambda_makeham = 0) %>%
filter(between(Age, 35, 95)) %>%
mutate(
l = log(1/(1-(qx+1E-15) )),
y = log(l-(lambda_makeham)*10^-5)
) %>%
# Segment the dataset by country and gender
group_by(`Country Name`, Gender) %>% nest %>%
mutate(
# Fit model
model = map(data, ~lm(y~Age ,data=.)),
# Extracts params
l_m = map_dbl(data, ~unique(.$lambda_makeham)),
params = map(model, ~data_frame(
K0 = .$coefficients[1],
g = .$coefficients[2],
lnh = as.numeric(K0-log((exp(g)-1)/g)),
m = (log(g) - lnh)/g,
b = 1/g
))
) %>%
select(-c(data, model)) %>%
unnest(params) %>% compute_stage2 %>% compute_table2
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
mutate(lambda_makeham = 0) %>%
filter(between(Age, 35, 95)) ->
dataset
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
mutate(lambda_makeham = 0) %>%
filter(between(Age, 35, 95)) ->
narrow_dt
source('~/.active-rstudio-document', echo=TRUE)
source('~/.active-rstudio-document', echo=TRUE)
source('~/.active-rstudio-document', echo=TRUE)
rm(list=ls())
library(readr)
library(readxl)
source("./scripts/00_method.R")
# Read Data
cc = read_csv("./initial_replication/manual_coef.csv") %>%
select(Country = m_cc, `Country Name`, M=lmakeham_M, F=lmakeham_F) %>%
gather(Gender, lambda_makeham, -c(Country, `Country Name`))
World_Mortality_2011 <- read_excel("./initial_replication/World_Mortality_2011.xlsx", skip = 1)
# Mutate dataset to fit modelling (going from flat to narrow table)
World_Mortality_2011 %>%
gather(Country_Sex, qx, -c(Year, Age)) %>%
separate(Country_Sex, c("Country", "Gender"), '_') ->
narrow_dt
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
mutate(lambda_makeham = 0) %>%
filter(between(Age, 35, 95)) ->
narrow_dt
narrow_dt %>% compute_stage1 %>% compute_stage2 %>% compute_table2
narrow_dt %>% compute_stage1 %>% compute_stage2 %>% compute_table2
narrow_dt %>% mutate(lambda_makeham = 0)%>%
compute_stage1 %>% compute_stage2 %>% compute_table2
library(kable)
library(knitr)
qeps=1E-15
narrow_dt %>% mutate(
l = log(1/(1-qx+qeps)),
y = log(l-(lambda_makeham)*10^-5)
)
narrow_dt %>% mutate(
l = log(1/(1-qx+qeps)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
narrow_dt %>% mutate(
l = log(1/(1-qx+1E-10)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
narrow_dt %>% mutate(
l = log(1/(1-qx-1E-10)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
source('/mnt/sd-linux/projects/Freelance/Moshe-Book/scripts/00_method.R', echo=TRUE)
narrow_dt %>%compute_stage1
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
#mutate(lambda_makeham = 0) %>%
filter(between(Age, 35, 95)) ->
narrow_dt
narrow_dt %>%compute_stage1
World_Mortality_2011 %>%
gather(Country_Sex, qx, -c(Year, Age)) %>%
separate(Country_Sex, c("Country", "Gender"), '_') ->
narrow_dt
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
filter(between(Age, 35, 95)) ->
narrow_dt
narrow_dt %>% compute_stage1
narrow_dt %>%
mutate(
l = log(1/(1-qx-1E-10)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
narrow_dt %>%
mutate(
l = log(1/(1-qx-1E-15)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
log(1/(1-0))
log(1/(1-1))
log(1/(1-2))
log(1/(1-0))
log(1/(1-0.5))
log(1/(1-0.35))
log(1/(1-0.05))
log(1/(1-0.005))
log(1/(1-0.0005))
log(1/(1-1E-15))
log(1/(1-1E-10))
narrow_dt %>%
mutate(
l = log(1/(1-qx-1E-15)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
narrow_dt %>%
mutate(
l = log(1/(1-qx-1E-5)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
narrow_dt %>% compute_stage1(1E-5)
narrow_dt %>% compute_stage1(1E-5) %>% compute_stage2 %>% compute_table2
narrow_dt %>% compute_stage1(1E-10) %>% compute_stage2 %>% compute_table2
narrow_dt
narrow_dt %>%
filter(qx == 0)
narrow_dt %>%
filter(Country == "ISL")
narrow_dt %>%
filter(Country == "ISL") %>% ggplot() +
geom_line(aes(y=qx, x=Age))
narrow_dt %>%
filter(Country == "ISL") %>% ggplot() +
geom_line(aes(y=qx, x=Age, group=Gender))
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>% ggplot() +
geom_line(aes(y=qx, x=Age, group=Gender))
narrow_dt %>% filter(Age < 40)
narrow_dt %>% filter(Age < 40) %>% filter(Gender == "F")
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL")
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Country, Gender) %>% arrange(Age)
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age)
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = qx[2:n()] )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = c(qx[1], qx[2:n()]) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = c(qx[1], qx[2:n()-1]) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = c(qx[1], qx[ 1:n()-1]) )
?lag
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = lag(qx) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = lag(qx, 1) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = lag(qx, 0) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = lag(qx, 1) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = lag(qx), next_qx = lead(qx) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = lag(qx), next_qx = lead(qx) )
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = (lag(qx)+lead(qx))/2 )
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = (lag(qx)+lead(qx))/2 )
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) -> #%>%
#mutate(lambda_makeham = 0) %>%
#filter(between(Age, 35, 95)) ->
narrow_dt
narrow_dt
# Mutate dataset to fit modelling (going from flat to narrow table)
World_Mortality_2011 %>%
gather(Country_Sex, qx, -c(Year, Age)) %>%
separate(Country_Sex, c("Country", "Gender"), '_') ->
narrow_dt
# Compute Stage 1
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) -> #%>%
#mutate(lambda_makeham = 0) %>%
#filter(between(Age, 35, 95)) ->
narrow_dt
narrow_dt
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( last_qx = (lag(qx)+lead(qx))/2 )
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( qx = replace(qx, qx == 0, (lag(qx)+lead(qx))/2 ) )
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) )
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) %>%
filter(between(Age, 30, 40)) %>% ggplot() + geom_line(aes(y=qx, x=Age))
(Age)
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) %>%
filter(between(Age, 30, 40))
rm(list=ls())
library(readr)
library(readxl)
library(knitr)
source("../scripts/00_method.R")
# Read Data
cc = read_csv("../initial_replication/manual_coef.csv") %>%
select(Country = m_cc, `Country Name`, M=lmakeham_M, F=lmakeham_F) %>%
gather(Gender, lambda_makeham, -c(Country, `Country Name`))
World_Mortality_2011 <- read_excel("../initial_replication/World_Mortality_2011.xlsx", skip = 1)
# Mutate dataset to fit modelling (going from flat to narrow table)
World_Mortality_2011 %>%
gather(Country_Sex, qx, -c(Year, Age)) %>%
separate(Country_Sex, c("Country", "Gender"), '_') ->
narrow_dt
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) %>%
filter(between(Age, 35, 95)) ->
narrow_dt
narrow_dt %>%
compute_stage1(0) %>% compute_stage2 %>% compute_table2 %>%
kable
narrow_dt %>% mutate(lambda_makeham = 0)%>%
compute_stage1(0) %>% compute_stage2 %>% compute_table2 %>%
kable
narrow_dt %>% mutate(lambda_makeham = 0) %>% filter(Country == "ISL") %>%
compute_stage1(0) %>% compute_stage2 %>% compute_table2 %>%
kable
narrow_dt %>% compute_stage1(1E-10) %>% compute_stage2 %>% compute_table2
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx-1E-5)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.nan(y))
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx-1E-5)),
y = log(l-(lambda_makeham)*10^-5)
) %>% filter(is.infinite(y))
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx-1E-5)),
y = log(l-(lambda_makeham)*10^-5)
)
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx-1E-5)),
y = log(l-(lambda_makeham)*10^-5)
) %>% arrange(y)
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx-1E-5)),
y = log(l-(lambda_makeham)*10^-5)
) %>% arrange(desc(y))
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx)),
y = log(l-(lambda_makeham)*10^-5)
) %>% arrange(desc(y))
narrow_dt %>% mutate(lambda_makeham = 0) %>%
mutate(
l = log(1/(1-qx)),
y = log(l-(lambda_makeham)*10^-5)
) %>% arrange(y)
narrow_dt %>% mutate(lambda_makeham = 0) %>% filter(Country != "ISL") %>%
compute_stage1(0) %>% compute_stage2 %>% compute_table2 %>%
kable
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) %>%
filter(between(Age, 30, 40))
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) #%>%
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) -> narrow_dt
library(readr)
library(readxl)
library(knitr)
source("../scripts/00_method.R")
# Read Data
cc = read_csv("../initial_replication/manual_coef.csv") %>%
select(Country = m_cc, `Country Name`, M=lmakeham_M, F=lmakeham_F) %>%
gather(Gender, lambda_makeham, -c(Country, `Country Name`))
World_Mortality_2011 <- read_excel("../initial_replication/World_Mortality_2011.xlsx", skip = 1)
# Mutate dataset to fit modelling (going from flat to narrow table)
World_Mortality_2011 %>%
gather(Country_Sex, qx, -c(Year, Age)) %>%
separate(Country_Sex, c("Country", "Gender"), '_') ->
narrow_dt
narrow_dt %>%
inner_join(cc, by=c("Country", "Gender")) -> narrow_dt
%>%
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) #%>%
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) %>%
filter(between(Age, 30, 40))
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% filter(Gender == "F") %>%
group_by(Gender, Country) %>% arrange(Age) %>%
mutate( ll_qx = (lag(qx)+lead(qx))/2 ) %>%
mutate( qx = replace(qx, qx == 0, ll_qx[qx==0]) ) %>%
filter(between(Age, 35, 40))
narrow_dt %>% #filter(Age < 40) %>%
filter(Country == "ISL") %>% ggplot(aes(y=qx, x=Age)) + geom_line()
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>% ggplot(aes(y=qx, x=Age)) + geom_line()
narrow_dt %>% filter(Age < 40) %>%
filter(Country == "ISL") %>%
ggplot(aes(y=qx, x=Age)) + facet_grid(~Gender) + geom_line()
